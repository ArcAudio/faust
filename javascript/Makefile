
jssrc := $(wildcard src/*.ts)

MAKE      ?= make
BUILD     := ../build
FAUSTWEB  := FaustLibrary.js		# the output javascript library name
DISTDIR   := npm/dist
SAMPLEDIR := npm/exemples
FAUSTAPI  := src/FaustCompiler.d.ts src/FaustWebAudio.d.ts src/FaustUtilities.d.ts src/FaustGenerator.d.ts src/FaustWAP.d.ts src/Faust2AudioNode.d.ts
FAUSTDIST := $(FAUSTAPI:src/%=$(DISTDIR)/%)
CHECKDIR  := tmp
SRC       := $(shell find src -name "*.ts" | egrep -v ".d.ts")
CHECKOUT  := $(SRC:src/%.ts=$(CHECKDIR)/%.js)
CHECKDIST := $(FAUSTDIST:$(DISTDIR)/%.ts=$(CHECKDIR)/%.js)
FAUSTDIST := $(FAUSTAPI:src/%=$(DISTDIR)/%)


all: 
	$(MAKE) wasm
	$(MAKE) js
	$(MAKE) dist

help:
	@echo "============================================================"
	@echo "                     Faust Wasm Library"
	@echo "This Makefile is intended to generate the faust wasm library"
	@echo "============================================================"
	@echo "Available targets are:"
	@echo "  all (default) : call the wasm, js and dist targets"
	@echo "  wasm          : compiles the wasm library"
	@echo "  js            : compiles the javascript library"
	@echo "  dist          : build the public library interface"
	@echo
	@echo "Development specific targets:"
	@echo "  check    : check individual ts files compilation, including the dist interface"
	@echo "  cmake    : re-generates the wasm library makefile using cmake"
	@echo "  clean    : remove the files generated by the wasm, js and dist targets"
	@echo
	@echo "Making the current version publicly available:"
	@echo "  publish  : publish to npm (use with care)"


wasm:
	$(MAKE) -C $(BUILD) wasmlib
# 	[ -e tests/libfaust-wasm.data ] || (cd tests && ln -s ../npm/dist/libfaust-wasm.data .)
# 	[ -e npm/exemples/libfaust-wasm.data ] || (cd npm/exemples && ln -s ../dist/libfaust-wasm.data .)

js: $(FAUSTWEB)

dist: 
	cp $(FAUSTAPI) $(DISTDIR)
	cp $(FAUSTWEB) $(DISTDIR)
	cp $(FAUSTWEB) $(SAMPLEDIR)
	cp $(BUILD)/lib/libfaust-wasm.* $(DISTDIR)
	cp $(BUILD)/lib/libfaust-wasm.* $(SAMPLEDIR)

$(FAUSTWEB) : $(jssrc)
	tsc --strict --strictNullChecks --alwaysStrict

clean:
	$(MAKE) -C $(BUILD)/faustdir/emcc clean
	rm -f $(FAUSTWEB) $(FAUSTDIST)
	rm -f $(FAUSTDIST) $(DISTDIR)/libfaust-wasm.*
	rm -f $(SAMPLEDIR)/libfaust-wasm.*

cmake:
	$(MAKE) -C $(BUILD) cmake

test:
	@echo $(FAUSTDIST)

###################################################
# check that individual files compile correctly
# check that public interfaces are self contained (no refs to undefined types) 
check: $(CHECKDIR) $(CHECKOUT) $(CHECKDIST)

$(CHECKDIR) :
	mkdir $(FAUSTDIST)

###################################################
# rules to compile individual files

TSOPT  := --strict --strictNullChecks --noImplicitAny --strictFunctionTypes --noImplicitThis --alwaysStrict --noImplicitReturns --noFallthroughCasesInSwitch --target ES2015

$(CHECKDIR)/%.d.js: $(DISTDIR)/%.d.ts
	tsc $(TSOPT) -out $@ $< || (rm $@ ; false)

$(CHECKDIR)/%.js: src/%.ts
	tsc $(TSOPT) -out $@ $< || (rm $@ ; false)
