<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <script src="../dist/libfaust-wasm.js"></script>
        <script src="../dist/libfaust-wasm.data"></script>
        <script src="../dist/FaustLibrary.js"></script>
    </head>
    <body style="position: absolute; width: 100%; height: 100%; margin: 100px">
        <h1>Faust Web Assembly Library</h1>
        <h2>Poly Audio node example</h2>
        <h3>Compiles and run the following dsp code with 4 voices</h3>
        <pre id=code>
import("stdfaust.lib");
process = ba.pulsen(1, ba.hz2midikey(freq) * 1000) : pm.marimba(freq, 0, 7000, 0.5, 0.8) * gate * gain with {
  freq = hslider("freq", 440, 40, 8000, 1);
  gain = hslider("gain", 0.5, 0, 1, 0.01);
  gate = button("gate");
};
effect = dm.freeverb_demo;
        </pre>
        <p id=log>   </p>
        <p>More information about <a href=https://faust.grame.fr>Faust</a></p>
    </body>
    <script>
        function getcode()  { return document.getElementById("code").textContent; }
        function log(msg)   { let div = document.getElementById("log"); div.textContent = msg + "\n"; }
        function play(node)   { 
            node.keyOn(0, 60, 100);
            setTimeout(() => node.keyOn(0, 64, 40), 500);
            setTimeout(() => node.keyOn(0, 67, 80), 1000);
            setTimeout(() => node.allNotesOff(), 5000);
            setTimeout(() => play(node), 7000);
        }
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        FaustModule().then ( module => { 
            let compiler = Faust.createCompiler ( Faust.createLibFaust(module) );
            log ("Faust compiler version " + compiler.version());
            let factory = Faust.createAudioNodeFactory();
            factory.compilePolyNode ( audioCtx, "Faust", compiler, getcode(), "-I libraries", 4, false, 128).then (node => {
                window.node = node;
                node.connect(audioCtx.destination);
                play(node);
            });
        });
        const unlockAudioContext = (audioCtx) => {
            if (audioCtx.state !== "suspended") return;
            const b = document.body;
            const events = ["touchstart", "touchend", "mousedown", "keydown"];
            const unlock = () => audioCtx.resume().then(clean);
            const clean = () => events.forEach(e => b.removeEventListener(e, unlock));
            events.forEach(e => b.addEventListener(e, unlock, false));
        }
        unlockAudioContext(audioCtx); 
    </script>
</html>
