<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
	<title>LibFaustWasm API Test</title>
	<script src="../npm/dist/libfaust-wasm.js"></script>
	<!-- <script src="../faustcompiler.js"></script> -->
	<script src="../faustwebaudio.js"></script>
	<script src="testCompiler.js"></script>
	<style>
	body { margin: 50; }
	pre { margin: 20; }
	svg { width: 600px; height: 300px;}
	</style>
</head>

<body>

<h1>LibFaustWasm API Test</h1>
<hr>
<pre id=log>
</pre>
<div id=svg1 class="svg">
</div>
<div id=svg2 class="svg">
</div>
<hr>

<script>
var div = document.getElementById("log");
function log (str) 			{ div.innerHTML += str + '\n'; }
function svg (str, name) 	{ log (str); }

const noise = 'random  = +(12345)~*(1103515245); \
noise = random/2147483647.0; \
process = noise * vslider("Volume", 0.2, 0, 1, 0.1) <: (*(0.01),*(0.01));';

const osc = 'import("stdfaust.lib"); \
vol = hslider("volume [unit:dB]", 0, -96, 0, 0.1) : ba.db2linear : si.smoo; \
freq = hslider("freq [unit:Hz]", 1000, 20, 24000, 1); \
process = vgroup("Oscillator", os.osc(freq) * vol);';

const osc2 = 'import("stdfaust.lib"); \
f = hslider("freq",440,50,2000,0.01); \
phasor(freq) = (+(freq/ma.SR) ~ ma.decimal); \
osc(freq) = sin(phasor(freq)*2*ma.PI); \
process = osc(f);';

const osc3 = 'import("stdfaust.lib"); \
f = hslider("freq",440,50,2000,0.01); \
phasor(freq) = (+(freq/ma.SR) ~ ma.decimal); \
process = phasor(f);';


const t1 = 'process = 0.125,0.3,0.4,0.8;';

//const dspcode = osc;
//const dspcode = noise;
const dspcode = osc2;
//const dspcode = osc3;
//const dspcode = t1;

// Allocate audio context
const context = new (window.AudioContext)(({ latencyHint: 0.00001 }));
console.log(context);
	
function doit (faust, context) {
	run (faust, log, dspcode, context);
}

// On desktop
window.addEventListener("mousedown", () => {
    if (context.state !== "suspended") return;
    context.resume().then(() => console.log("Audio resumed"))
});

FaustModule().then((instance) => { 
	doit (new Faust.LibFaust(instance), context); });

</script>
</body>
</html>
