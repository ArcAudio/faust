
jssrc := $(wildcard src/*.ts)

FAUSTWEB  := faustwebaudio.js
FAUSTDIST := npm/dist/faustwebaudio.d.ts
CHECKDIR  := tmp
SRC       := $(shell find src -name "*.ts" | egrep -v ".d.ts")
CHECKOUT  := $(patsubst src/%.ts, $(CHECKDIR)/%.js, $(SRC))


all: 
	make wasm
	make js

help:
	@echo "============================================================"
	@echo "                     Faust Wasm Library"
	@echo "This Makefile is intended to generate the faust wasm library"
	@echo "============================================================"
	@echo "Available targets are:"
	@echo "  all (default) : call the wasm and js targets"
	@echo "  wasm          : compiles the wasm library"
	@echo "  js            : compiles the javascript library"
	@echo "  dist          : build the public library interface"
	@echo
	@echo "Development specific targets:"
	@echo "  check    : check individual ts files compilation, including the dist interface"
	@echo "  cmake    : re-generates the wasm library makefile using cmake"
	@echo "  clean    : remove the files generated by the wasm, js and dist targets"
	@echo
	@echo "Making the current version publicly available:"
	@echo "  publish  : make all + dist"


wasm:
	make -C .. wasmlib
	cp ../lib/libfaust-wasm.* npm/dist
	[ -e tests/libfaust-wasm.data ] || (cd tests && ln -s ../npm/dist/libfaust-wasm.data .)

js: $(FAUSTWEB) faustcompiler.js

dist: $(FAUSTDIST)

$(FAUSTDIST) : header.txt src/FaustCompiler.d.ts src/FaustWebAudio.d.ts src/FaustUtilities.d.ts
	cat header.txt src/FaustCompiler.d.ts src/FaustWebAudio.d.ts src/FaustUtilities.d.ts > $@

$(FAUSTWEB) : $(jssrc)
	tsc --strict --strictNullChecks --alwaysStrict

faustcompiler.js : src/FaustCompiler.d.ts src/FaustCompiler.ts src/libfaust.d.ts
	tsc -p tsCompiler.json

clean:
	make -C ../faustdir/emcc clean
	rm -f $(FAUSTWEB) $(FAUSTDIST)

cmake:
	make -C .. cmake

test:
	@echo $(SRC)

###################################################
# rules to compile individual files

check: $(CHECKDIR) $(CHECKOUT) $(CHECKDIR)/interface.js

$(CHECKDIR) :
	mkdir $(CHECKDIR)

TSOPT  := --strict --strictNullChecks --noImplicitAny --strictFunctionTypes --noImplicitThis --alwaysStrict --noImplicitReturns --noFallthroughCasesInSwitch --target ES2015

$(CHECKDIR)/interface.js: $(FAUSTDIST)
	tsc $(TSOPT) -out $@ $< || rm $@

$(CHECKDIR)/%.js: src/%.ts
	tsc $(TSOPT) -out $@ $< || rm $@
